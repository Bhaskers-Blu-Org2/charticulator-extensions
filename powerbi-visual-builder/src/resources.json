{"icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAABuAAAAbgEj5T6nAAAB3klEQVQ4jZWTv08TYRjHv/e+pRymNISUCyc6tCSEgGCUpTgYJxPj5uDigjgZY5gw/gMMhMFVFxkIEyhJE0mYijH4Y1MhLlVSLVibYMn10rvewT2vw9ucXMPB8eQdnud538/zM6+yV3Pym2UigbMI5+zGiB7Lb5afbvSeiZQyp1RiMif/NBc3tyNiTiJD2WkSIibtuLndsb8VESYSDgAgdurThyruxhWpv7S8hUPmX7EQpCkXGMb5f9OoGZ7n+WYgszV0vzE8KfW2wuvOz88m2kFE4M0AQgSWEsh8NKqbujLWe7kPgojC6gotuw20M/SgrrSH9xQs+3zxDf3Iy9oS448aHamF4cdTX2cjwXfE34lzVakvlXKLA5PFrsH1vpuV4qqMuOMcQA2BiQhozmbsz7sN7Vqxa3A+c6+q3ZLOw2/L2v7743tuGebtwqJNVBWcX8zKo/b0MxZtz0nz5+6XVwoU32PV60eHfxI8U66Kwgq8RtiDQM9ljz6YltTXDOu7YKmkWivkDmxDduQZpVB41aEXpV1ZmKqquq5zzpO/cr8/PrdtGwBjDOl0K+wk0vJv6tpV/84FXABAd/eo72wAbmemCXPOAFD2iXNC98cJZ0zZM923W5WWJUUhr1/S/gGSZcZlr2sqngAAAABJRU5ErkJggg==","libraries":"","visual":"// The main file for the visual\r\n\r\n(function (powerbi) {\r\n    if (powerbi.visuals == undefined) powerbi.visuals = {};\r\n    if (powerbi.extensibility == undefined) powerbi.extensibility = {};\r\n    if (powerbi.extensibility.visual == undefined) powerbi.extensibility.visual = {};\r\n    if (powerbi.visuals.plugins == undefined) powerbi.visuals.plugins = {};\r\n    powerbi.visuals.plugins['<%= pluginName %>'] = {\r\n        name: '<%= pluginName %>',\r\n        displayName: '<%= visualDisplayName %>',\r\n        class: 'CharticulatorPowerBIVisual',\r\n        version: '<%= visualVersion %>',\r\n        apiVersion: '<%= apiVersion %>',\r\n        create: (options) => {\r\n            return new powerbi.extensibility.visual['<%= visualGuid %>'].CharticulatorPowerBIVisual(options);\r\n        },\r\n        custom: true\r\n    };\r\n\r\n    let isInitialized = false;\r\n    let initializeCallbacks = [];\r\n\r\n    function runAfterInitialized(f) {\r\n        if (isInitialized) {\r\n            f();\r\n        } else {\r\n            initializeCallbacks.push(f);\r\n        }\r\n    }\r\n\r\n    CharticulatorContainer.initialize({\r\n        MapService: null\r\n    }).then(() => {\r\n        isInitialized = true;\r\n        initializeCallbacks.forEach(f => f());\r\n    });\r\n\r\n    class CharticulatorPowerBIVisual {\r\n        constructor(options) {\r\n            try {\r\n                this.selectionManager = options.host.createSelectionManager();\r\n                this.template = '<%= templateData %>';\r\n                this.containerElement = document.createElement(\"div\");\r\n                this.host = options.host;\r\n                this.properties = {};\r\n                options.element.appendChild(this.containerElement);\r\n                this.chartTemplate = new CharticulatorContainer.ChartTemplate(this.template);\r\n                this.chartInstance = null;\r\n                for (let id in this.template.properties) {\r\n                    if (!this.template.properties.hasOwnProperty(id)) continue;\r\n                    for (let p of this.template.properties[id]) {\r\n                        this.properties[p.name] = p.default;\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.log(e);\r\n            }\r\n        }\r\n\r\n        getPixelRatio() {\r\n            // FIXME: window.devicePixelRatio result in IllegalInvocation error in PowerBI visuals.\r\n            // We fix this to 2 for now\r\n            return 2;\r\n        }\r\n\r\n        resize(width, height) {\r\n            this.containerElement.style.width = width + \"px\";\r\n            this.containerElement.style.height = height + \"px\";\r\n        }\r\n\r\n        /** Get a Charticulator dataset from the options */\r\n        getDataset(options) {\r\n            if (!options.dataViews\r\n                || !options.dataViews[0]\r\n                || !options.dataViews[0].categorical\r\n                || !options.dataViews[0].categorical.categories\r\n                || !options.dataViews[0].categorical.categories[0]) {\r\n                return null;\r\n            }\r\n            let dv = options.dataViews[0];\r\n            let category = dv.categorical.categories[0];\r\n            let values = dv.categorical.values;\r\n            if (!values) return null;\r\n\r\n            let slotToValues = {};\r\n\r\n            for (let slot of this.template.dataSlots) {\r\n                let found = false;\r\n                for (let v of values) {\r\n                    if (v.source.roles[slot.powerBIName]) {\r\n                        slotToValues[slot.powerBIName] = v;\r\n                        found = true;\r\n                    }\r\n                }\r\n                if (!found) return null;\r\n            }\r\n            let dataset = {\r\n                name: \"Dataset\",\r\n                tables: [{\r\n                    name: \"default\",\r\n                    columns: [\r\n                        this.template.dataSlots.map(slot => {\r\n                            return {\r\n                                name: slot.powerBIName,\r\n                                type: \"any\",\r\n                                metadata: {\r\n                                    kind: \"any\"\r\n                                }\r\n                            };\r\n                        })\r\n                    ],\r\n                    rows: category.values.map((d, i) => {\r\n                        let obj = {};\r\n                        // ID is the category value\r\n                        obj._id = \"ID\" + i.toString();\r\n                        for (let slot of this.template.dataSlots) {\r\n                            let value = slotToValues[slot.powerBIName].values[i];\r\n                            if (value == null) return null;\r\n                            obj[slot.powerBIName] = value.valueOf();\r\n                            if (slot.kind == \"categorical\") {\r\n                                obj[slot.powerBIName] = obj[slot.powerBIName].toString();\r\n                            }\r\n                        }\r\n                        return obj;\r\n                    }).filter(x => x != null)\r\n                }]\r\n            };\r\n            return dataset;\r\n        }\r\n\r\n        getProperties(options) {\r\n            let defaultProperties = {};\r\n            for (let id in this.template.properties) {\r\n                if (!this.template.properties.hasOwnProperty(id)) continue;\r\n                for (let p of this.template.properties[id]) {\r\n                    defaultProperties[p.name] = p.default;\r\n                }\r\n            }\r\n\r\n            if (!options || !options.dataViews || !options.dataViews[0] || !options.dataViews[0].metadata) return defaultProperties;\r\n            let objects = options.dataViews[0].metadata.objects;\r\n            if (!objects) return defaultProperties;\r\n\r\n            for (let id in this.template.properties) {\r\n                if (!this.template.properties.hasOwnProperty(id)) continue;\r\n                for (let p of this.template.properties[id]) {\r\n                    let object = objects.chartOptions;\r\n                    defaultProperties[p.name] = object[p.name];\r\n                }\r\n            }\r\n\r\n            return defaultProperties;\r\n        }\r\n\r\n        update(options) {\r\n            runAfterInitialized(() => this.updateRun(options));\r\n        }\r\n\r\n        updateRun(options) {\r\n            try {\r\n                this.resize(options.viewport.width, options.viewport.height);\r\n\r\n                let dataset = this.getDataset(options);\r\n                this.properties = this.getProperties(options);\r\n\r\n                if (dataset == null) {\r\n                    this.containerElement.innerHTML = `\r\n                        <h2>Dataset incomplete. Please specify all data fields.</h2>\r\n                    `;\r\n                    this.currentDatasetJSON = null;\r\n                    this.chartInstance = null;\r\n                } else {\r\n                    let datasetJSON = JSON.stringify(dataset);\r\n                    if (datasetJSON != this.currentDatasetJSON) {\r\n                        this.chartInstance = null;\r\n                    }\r\n\r\n                    this.currentDatasetJSON = datasetJSON;\r\n                    if (!this.chartInstance) {\r\n                        this.containerElement.innerHTML = '';\r\n                        this.chartTemplate.reset();\r\n                        for (let slot of this.template.dataSlots) {\r\n                            this.chartTemplate.assignSlot(slot.name, slot.powerBIName);\r\n                        }\r\n                        for (let table of this.template.tables) {\r\n                            this.chartTemplate.assignTable(table.name, \"default\");\r\n                        }\r\n                        this.chartInstance = this.chartTemplate.instantiate(dataset);\r\n                        this.chartInstance.addListener(\"selection\", () => {\r\n                            const selection = this.chartInstance.currentSelection;\r\n                            if (selection !== undefined) {\r\n                                const categoryColumn = options.dataViews[0].categorical.categories[0];\r\n                                const toSelect =\r\n                                    this.host.createSelectionIdBuilder()\r\n                                        .withCategory(categoryColumn, selection.dataIndex)\r\n                                        .createSelectionId();\r\n                                this.selectionManager.select(toSelect);\r\n                            } else {\r\n                                this.selectionManager.clear();\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    if (this.chartInstance) {\r\n                        // Feed in properties\r\n                        for (let id in this.template.properties) {\r\n                            if (!this.template.properties.hasOwnProperty(id)) continue;\r\n                            for (let p of this.template.properties[id]) {\r\n                                let value = this.properties[p.name];\r\n                                if (value == null) value = p.default;\r\n                                let object = this.chartTemplate.findObjectById(this.chartInstance.chart, id);\r\n                                switch (p.mode) {\r\n                                    case \"attribute\": {\r\n                                        object.mappings[p.attribute] = { type: \"value\", value: value };\r\n                                    } break;\r\n                                    case \"property\": {\r\n                                        if (p.fields) {\r\n                                            CharticulatorContainer.setField(object.properties[p.property], p.fields, value);\r\n                                        } else {\r\n                                            object.properties[p.property] = value;\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        this.chartInstance.resize(options.viewport.width, options.viewport.height);\r\n                        this.chartInstance.update();\r\n                        this.chartInstance.render(this.containerElement);\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.log(e);\r\n            }\r\n        }\r\n\r\n        enumerateObjectInstances(options) {\r\n            let objectName = options.objectName;\r\n            let objectEnumeration = [];\r\n            switch (objectName) {\r\n                case 'chartOptions':\r\n                    objectEnumeration.push({\r\n                        objectName: objectName,\r\n                        properties: this.properties,\r\n                        selector: null\r\n                    });\r\n            };\r\n            return objectEnumeration;\r\n        }\r\n    }\r\n\r\n    powerbi.extensibility.visual['<%= visualGuid %>'] = {\r\n        CharticulatorPowerBIVisual: CharticulatorPowerBIVisual\r\n    };\r\n\r\n})(powerbi);"}