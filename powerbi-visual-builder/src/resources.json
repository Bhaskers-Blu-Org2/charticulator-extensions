{"icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAABuAAAAbgEj5T6nAAAB3klEQVQ4jZWTv08TYRjHv/e+pRymNISUCyc6tCSEgGCUpTgYJxPj5uDigjgZY5gw/gMMhMFVFxkIEyhJE0mYijH4Y1MhLlVSLVibYMn10rvewT2vw9ucXMPB8eQdnud538/zM6+yV3Pym2UigbMI5+zGiB7Lb5afbvSeiZQyp1RiMif/NBc3tyNiTiJD2WkSIibtuLndsb8VESYSDgAgdurThyruxhWpv7S8hUPmX7EQpCkXGMb5f9OoGZ7n+WYgszV0vzE8KfW2wuvOz88m2kFE4M0AQgSWEsh8NKqbujLWe7kPgojC6gotuw20M/SgrrSH9xQs+3zxDf3Iy9oS448aHamF4cdTX2cjwXfE34lzVakvlXKLA5PFrsH1vpuV4qqMuOMcQA2BiQhozmbsz7sN7Vqxa3A+c6+q3ZLOw2/L2v7743tuGebtwqJNVBWcX8zKo/b0MxZtz0nz5+6XVwoU32PV60eHfxI8U66Kwgq8RtiDQM9ljz6YltTXDOu7YKmkWivkDmxDduQZpVB41aEXpV1ZmKqquq5zzpO/cr8/PrdtGwBjDOl0K+wk0vJv6tpV/84FXABAd/eo72wAbmemCXPOAFD2iXNC98cJZ0zZM923W5WWJUUhr1/S/gGSZcZlr2sqngAAAABJRU5ErkJggg==","libraries":"","visual":"// The main file for the visual\n\n(function (powerbi) {\n    if (powerbi.visuals == undefined) powerbi.visuals = {};\n    if (powerbi.extensibility == undefined) powerbi.extensibility = {};\n    if (powerbi.extensibility.visual == undefined) powerbi.extensibility.visual = {};\n    if (powerbi.visuals.plugins == undefined) powerbi.visuals.plugins = {};\n    powerbi.visuals.plugins['<%= pluginName %>'] = {\n        name: '<%= pluginName %>',\n        displayName: '<%= visualDisplayName %>',\n        class: 'CharticulatorPowerBIVisual',\n        version: '<%= visualVersion %>',\n        apiVersion: '<%= apiVersion %>',\n        create: (options) => {\n            return new powerbi.extensibility.visual['<%= visualGuid %>'].CharticulatorPowerBIVisual(options);\n        },\n        custom: true\n    };\n\n    let isInitialized = false;\n    let initializeCallbacks = [];\n\n    function runAfterInitialized(f) {\n        if (isInitialized) {\n            f();\n        } else {\n            initializeCallbacks.push(f);\n        }\n    }\n\n    CharticulatorContainer.initialize({\n        MapService: null\n    }).then(() => {\n        isInitialized = true;\n        initializeCallbacks.forEach(f => f());\n    });\n\n    class CharticulatorPowerBIVisual {\n        constructor(options) {\n            try {\n                this.template = '<%= templateData %>';\n                this.canvas = document.createElement(\"canvas\");\n                this.properties = {};\n                options.element.appendChild(this.canvas);\n                this.chartTemplate = new CharticulatorContainer.ChartTemplate(this.template);\n                this.chartInstance = null;\n                for (let id in this.template.properties) {\n                    if (!this.template.properties.hasOwnProperty(id)) continue;\n                    for (let p of this.template.properties[id]) {\n                        this.properties[p.name] = p.default;\n                    }\n                }\n            } catch (e) {\n                console.log(e);\n            }\n        }\n\n        getPixelRatio() {\n            // FIXME: window.devicePixelRatio result in IllegalInvocation error in PowerBI visuals.\n            // We fix this to 2 for now\n            return 2;\n        }\n\n        resize(width, height) {\n            this.canvas.style.width = width + \"px\";\n            this.canvas.style.height = height + \"px\";\n            let pr = this.getPixelRatio();\n            this.canvas.width = Math.ceil(width * pr);\n            this.canvas.height = Math.ceil(height * pr);\n            let ctx = this.canvas.getContext(\"2d\");\n            ctx.setTransform(pr, 0, 0, pr, 0, 0);\n        }\n\n        /** Get a Charticulator dataset from the options */\n        getDataset(options) {\n            if (!options.dataViews\n                || !options.dataViews[0]\n                || !options.dataViews[0].categorical\n                || !options.dataViews[0].categorical.categories\n                || !options.dataViews[0].categorical.categories[0]) {\n                return null;\n            }\n            let dv = options.dataViews[0];\n            let category = dv.categorical.categories[0];\n            let values = dv.categorical.values;\n            if (!values) return null;\n\n            let slotToValues = {};\n\n            for (let slot of this.template.dataSlots) {\n                let found = false;\n                for (let v of values) {\n                    if (v.source.roles[slot.powerBIName]) {\n                        slotToValues[slot.powerBIName] = v;\n                        found = true;\n                    }\n                }\n                if (!found) return null;\n            }\n            let dataset = {\n                name: \"Dataset\",\n                tables: [{\n                    name: \"default\",\n                    columns: [\n                        this.template.dataSlots.map(slot => {\n                            return {\n                                name: slot.powerBIName,\n                                type: \"any\",\n                                metadata: {\n                                    kind: \"any\"\n                                }\n                            };\n                        })\n                    ],\n                    rows: category.values.map((d, i) => {\n                        let obj = {};\n                        // ID is the category value\n                        obj._id = \"ID\" + i.toString();\n                        for (let slot of this.template.dataSlots) {\n                            let value = slotToValues[slot.powerBIName].values[i];\n                            if (value == null) return null;\n                            obj[slot.powerBIName] = value.valueOf();\n                            if (slot.kind == \"categorical\") {\n                                obj[slot.powerBIName] = obj[slot.powerBIName].toString();\n                            }\n                        }\n                        return obj;\n                    }).filter(x => x != null)\n                }]\n            };\n            return dataset;\n        }\n\n        getProperties(options) {\n            let defaultProperties = {};\n            for (let id in this.template.properties) {\n                if (!this.template.properties.hasOwnProperty(id)) continue;\n                for (let p of this.template.properties[id]) {\n                    defaultProperties[p.name] = p.default;\n                }\n            }\n\n            if (!options || !options.dataViews || !options.dataViews[0] || !options.dataViews[0].metadata) return defaultProperties;\n            let objects = options.dataViews[0].metadata.objects;\n            if (!objects) return defaultProperties;\n\n            for (let id in this.template.properties) {\n                if (!this.template.properties.hasOwnProperty(id)) continue;\n                for (let p of this.template.properties[id]) {\n                    let object = objects.chartOptions;\n                    defaultProperties[p.name] = object[p.name];\n                }\n            }\n\n            return defaultProperties;\n        }\n\n        clearCanvas() {\n            let ctx = this.canvas.getContext(\"2d\");\n            ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n        }\n\n        update(options) {\n            runAfterInitialized(() => this.updateRun(options));\n        }\n\n        updateRun(options) {\n            try {\n                this.resize(options.viewport.width, options.viewport.height);\n                this.clearCanvas();\n                let ctx = this.canvas.getContext(\"2d\");\n\n                let dataset = this.getDataset(options);\n                this.properties = this.getProperties(options);\n\n                if (dataset == null) {\n                    ctx.fillStyle = \"black\";\n                    ctx.font = \"24px Arial\";\n                    ctx.textAlign = \"left\";\n                    ctx.fillText(\"Dataset incomplete. Please specify all data fields.\", 20, 20);\n                    this.currentDatasetJSON = null;\n                    this.chartInstance = null;\n                } else {\n                    let datasetJSON = JSON.stringify(dataset);\n                    if (datasetJSON != this.currentDatasetJSON) {\n                        this.chartInstance = null;\n                    }\n\n                    if (!this.chartInstance) {\n                        this.chartTemplate.reset();\n                        for (let slot of this.template.dataSlots) {\n                            this.chartTemplate.assignSlot(slot.name, slot.powerBIName);\n                        }\n                        for (let table of this.template.tables) {\n                            this.chartTemplate.assignTable(table.name, \"default\");\n                        }\n                        this.chartInstance = this.chartTemplate.instantiate(dataset);\n                    }\n\n                    if (this.chartInstance) {\n                        // Feed in properties\n                        for (let id in this.template.properties) {\n                            if (!this.template.properties.hasOwnProperty(id)) continue;\n                            for (let p of this.template.properties[id]) {\n                                let value = this.properties[p.name];\n                                if (value == null) value = p.default;\n                                let object = this.chartTemplate.findObjectById(this.chartInstance.chart, id);\n                                switch (p.mode) {\n                                    case \"attribute\": {\n                                        object.mappings[p.attribute] = { type: \"value\", value: value };\n                                    } break;\n                                    case \"property\": {\n                                        if (p.fields) {\n                                            CharticulatorContainer.setField(object.properties[p.property], p.fields, value);\n                                        } else {\n                                            object.properties[p.property] = value;\n                                        }\n                                    }\n                                }\n                            }\n                        }\n\n                        this.chartInstance.resize(options.viewport.width, options.viewport.height);\n                        this.chartInstance.update();\n                        this.chartInstance.render(ctx);\n                    }\n                }\n            } catch (e) {\n                console.log(e);\n            }\n        }\n\n        enumerateObjectInstances(options) {\n            let objectName = options.objectName;\n            let objectEnumeration = [];\n            switch (objectName) {\n                case 'chartOptions':\n                    objectEnumeration.push({\n                        objectName: objectName,\n                        properties: this.properties,\n                        selector: null\n                    });\n            };\n            return objectEnumeration;\n        }\n    }\n\n    powerbi.extensibility.visual['<%= visualGuid %>'] = {\n        CharticulatorPowerBIVisual: CharticulatorPowerBIVisual\n    };\n\n})(powerbi);"}